name: Build and Release

on:
  push:
    tags:
      - 'v*'

env:
  DOTNET_VERSION: '8.0.x'
  PROJECT_PATH: 'src/GeminiWebApi/GeminiWebApi.csproj'
  TESTS_PATH: 'tests/GeminiWebApi.Tests.csproj'

jobs:
  build-and-release:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Restore dependencies
      run: |
        dotnet restore ${{ env.PROJECT_PATH }}
        dotnet restore ${{ env.TESTS_PATH }}
    
    - name: Build Release
      run: |
        dotnet build ${{ env.PROJECT_PATH }} -c Release --no-restore
        dotnet build ${{ env.TESTS_PATH }} -c Release --no-restore
    
    - name: Run tests
      run: dotnet test ${{ env.TESTS_PATH }} -c Release --no-build --logger "console;verbosity=normal"
      continue-on-error: true
    
    - name: Create NuGet package
      run: dotnet pack ${{ env.PROJECT_PATH }} -c Release -o ./nupkg --no-build
    
    - name: Extract version from tag
      id: version
      shell: pwsh
      run: |
        $tag = "${{ github.ref }}".Replace("refs/tags/", "")
        $version = $tag.Replace("v", "")
        echo "TAG=$tag" >> $env:GITHUB_OUTPUT
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
    
    - name: Prepare release assets
      shell: pwsh
      run: |
        $outputDir = "release_assets"
        New-Item -ItemType Directory -Path $outputDir -Force
        
        # Copy DLL
        Copy-Item `
          "src/GeminiWebApi/bin/Release/net8.0/GeminiWebApi.dll" `
          "$outputDir/GeminiWebApi-${{ steps.version.outputs.VERSION }}.dll"
        
        # Copy PDB
        Copy-Item `
          "src/GeminiWebApi/bin/Release/net8.0/GeminiWebApi.pdb" `
          "$outputDir/GeminiWebApi-${{ steps.version.outputs.VERSION }}.pdb"
        
        # Copy deps.json
        Copy-Item `
          "src/GeminiWebApi/bin/Release/net8.0/GeminiWebApi.deps.json" `
          "$outputDir/GeminiWebApi.deps.json"
        
        # Find and copy nupkg
        $nupkg = Get-ChildItem nupkg -Filter "*.nupkg" | Select-Object -First 1
        if ($nupkg) {
          Copy-Item $nupkg.FullName "$outputDir/GeminiWebApi-${{ steps.version.outputs.VERSION }}.nupkg"
        }
        
        ls -Recurse $outputDir
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.TAG }}
        name: Release ${{ steps.version.outputs.VERSION }}
        draft: false
        prerelease: false
        files: release_assets/*
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Display release info
      run: |
        echo "âœ… Release created successfully!"
        echo "Release Name: Release ${{ steps.version.outputs.VERSION }}"
        echo "Tag: ${{ steps.version.outputs.TAG }}"
        echo "DLL: GeminiWebApi-${{ steps.version.outputs.VERSION }}.dll"
        echo "PDB: GeminiWebApi-${{ steps.version.outputs.VERSION }}.pdb"
        echo "NuGet: GeminiWebApi-${{ steps.version.outputs.VERSION }}.nupkg"
